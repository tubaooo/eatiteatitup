<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä»Šå¤©åƒä»€éº¼ï¼Ÿ | éš¨æ©Ÿç¾é£ŸæŠ½é¸</title>
    <!-- å¼•å…¥å¤–éƒ¨è³‡æº -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- å¼•å…¥ Serif (è¥¯ç·šé«”) å’Œ Sans (ç„¡è¥¯ç·šé«”) -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Noto+Serif+TC:wght@600;900&display=swap" rel="stylesheet">
    
    <style>
        [v-cloak] { display: none; }
        
        /* å…¨åŸŸå­—é«”è¨­å®šï¼šæ¨™é¡Œç”¨å®‹é«”ï¼Œå…§æ–‡ç”¨é»‘é«” */
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #f9fafb; /* æ·ºç°ç™½èƒŒæ™¯ */
            color: #374151; /* æ·±ç°æ–‡å­— */
            margin: 0; 
        }
        h1, h2, h3, .serif-font {
            font-family: 'Noto Serif TC', serif;
        }

        .gmnoprint, .gm-style-cc { display: none; }
        
        /* è¼‰å…¥å‹•ç•« (æ”¹ç‚ºæ·±è‰²) */
        .loader {
            border: 3px solid #e5e7eb;
            border-top: 3px solid #4b5563;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* ç‡Ÿæ¥­ä¸­é–‹é—œæ¨£å¼ (æ·ºè‰²ç‰ˆ) */
        .toggle-checkbox:checked { right: 0; border-color: #4b5563; }
        .toggle-checkbox:checked + .toggle-label { background-color: #4b5563; }

        /* ä¿®æ”¹é‡é»ï¼šå¤šå±¤æ¬¡æŸ”å’Œé™°å½±ï¼Œå¢å¼·æ–‡å­—å¯è®€æ€§ */
        .text-shadow-enhanced {
            text-shadow: 
                0 2px 4px rgba(0,0,0,0.7), 
                0 4px 8px rgba(0,0,0,0.5), 
                0 0 20px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>

<!-- 
    Layout ä¿®æ”¹ï¼š
    1. ç§»é™¤ max-w-mdï¼Œæ”¹ç‚º max-w-5xl (æ›´å¯¬)
    2. åŠ å…¥ md:flex md:gap-8 (é›»è…¦ç‰ˆå·¦å³æ’)
-->
<div id="app" v-cloak class="max-w-5xl mx-auto min-h-screen flex flex-col md:justify-center md:py-10 p-0 md:px-6">
    
    <div class="flex-1 w-full bg-white shadow-sm border border-gray-200 md:rounded-lg overflow-hidden flex flex-col md:flex-row">
        
        <!-- å·¦å´ï¼šæ“ä½œé¢æ¿ (é›»è…¦ç‰ˆä½” 40%) -->
        <div class="w-full md:w-5/12 bg-gray-50 border-b md:border-b-0 md:border-r border-gray-200 flex flex-col z-20">
            
            <header class="p-6 pb-4 border-b border-gray-200 bg-white">
                <h1 class="text-3xl font-black text-gray-800 tracking-wide">ä»Šå¤©åƒä»€éº¼ï¼Ÿ</h1>
                <p class="text-sm text-gray-500 mt-1 font-light tracking-widest">LUNCH SELECTOR</p>
            </header>

            <div class="p-6 flex-1 overflow-y-auto">
                
                <!-- éŒ¯èª¤æç¤º -->
                <div v-if="errorMessage" class="mb-6 bg-red-50 border-l-4 border-red-500 text-red-700 p-4 text-sm">
                    <div class="font-bold flex items-center gap-2">
                        éŒ¯èª¤è¨Šæ¯
                    </div>
                    <p class="mt-1">{{ errorMessage }}</p>
                    <div v-if="debugInfo" class="mt-2 text-xs font-mono text-red-400 opacity-75">
                        Code: {{ debugInfo }}
                    </div>
                </div>

                <div class="space-y-8">
                    <!-- åœ°é»é¸æ“‡ (ä¸‰æ®µå¼) -->
                    <div>
                        <label class="block text-gray-500 text-xs font-bold uppercase mb-2 tracking-widest">
                            æœå°‹å€åŸŸ
                        </label>
                        <div class="space-y-3">
                            <!-- ç¬¬ä¸€æ’ï¼šç¸£å¸‚èˆ‡åœ°å€ -->
                            <div class="flex gap-3">
                                <div class="w-1/2">
                                    <select v-model="selectedCity" @change="handleCityChange" class="w-full p-3 bg-white border border-gray-300 rounded-lg text-gray-800 outline-none focus:ring-2 focus:ring-gray-400 appearance-none cursor-pointer shadow-sm">
                                        <option value="" disabled>é¸æ“‡ç¸£å¸‚</option>
                                        <option v-for="(districts, city) in taiwanData" :key="city" :value="city">{{ city }}</option>
                                    </select>
                                </div>
                                <div class="w-1/2">
                                    <select v-model="selectedDistrict" :disabled="!selectedCity" class="w-full p-3 bg-white border border-gray-300 rounded-lg text-gray-800 outline-none focus:ring-2 focus:ring-gray-400 appearance-none cursor-pointer shadow-sm disabled:bg-gray-100 disabled:text-gray-400">
                                        <option value="" disabled>é¸æ“‡åœ°å€</option>
                                        <option v-for="dist in availableDistricts" :key="dist" :value="dist">{{ dist }}</option>
                                    </select>
                                </div>
                            </div>
                            <!-- ç¬¬äºŒæ’ï¼šè©³ç´°åœ°æ¨™ (é¸å¡«) -->
                            <input v-model="specificLocation" type="text" class="w-full p-3 bg-white border border-gray-300 rounded-lg text-gray-800 outline-none focus:ring-2 focus:ring-gray-400 transition-all shadow-sm placeholder-gray-400 text-sm" placeholder="åœ°æ¨™ (é¸å¡«ï¼Œä¾‹: è»Šç«™ã€å¸‚æ”¿åºœ)">
                        </div>
                    </div>

                    <!-- æ’é™¤æ¢ä»¶ -->
                    <div>
                        <label class="block text-gray-500 text-xs font-bold uppercase mb-2 tracking-widest">
                            æ’é™¤æ¢ä»¶
                        </label>
                        <div class="flex flex-wrap gap-2 mb-3">
                            <span v-for="(tag, index) in excludeTags" :key="index" @click="removeTag(index)" class="bg-white text-gray-600 px-3 py-1.5 rounded-full text-sm border border-gray-300 hover:border-red-300 hover:text-red-500 transition cursor-pointer flex items-center gap-2 shadow-sm">
                                {{ tag }} <span class="text-xs opacity-50">âœ•</span>
                            </span>
                        </div>
                        <div class="flex gap-2">
                            <input v-model="newExcludeTag" @keyup.enter="addTag" type="text" placeholder="æ–°å¢æ’é™¤ (ä¾‹: å’–å“©)" class="flex-1 p-3 bg-white border border-gray-300 rounded-lg text-sm outline-none focus:border-gray-500 transition-colors shadow-sm">
                            <button @click="addTag" class="bg-gray-800 hover:bg-gray-700 text-white px-4 rounded-lg font-bold transition-colors">+</button>
                        </div>
                    </div>

                    <!-- æŒ‰éˆ•å€ -->
                    <div class="pt-4">
                        <button @click="findLunch" :disabled="isLoading || !isMapsReady" class="w-full bg-gray-900 hover:bg-gray-800 text-white py-4 rounded-lg font-bold text-lg shadow-lg disabled:opacity-50 disabled:cursor-not-allowed transition-all transform active:scale-[0.98] flex justify-center items-center gap-3">
                            <div v-if="isLoading" class="loader border-white/20 border-t-white"></div>
                            <span v-else>é–‹å§‹éš¨æ©ŸæŠ½é¸</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="p-4 text-center text-xs text-gray-400 border-t border-gray-200 bg-white">
                å°ç£é™å®šæœå°‹ãƒ»è³‡æ–™ä¾†æº Google Maps
            </div>
        </div>

        <!-- å³å´ï¼šçµæœé¡¯ç¤º (é›»è…¦ç‰ˆä½” 60%) -->
        <div class="w-full md:w-7/12 bg-white relative min-h-[400px] md:min-h-0">
            
            <!-- é è¨­ç•«é¢ (é‚„æ²’æŠ½çš„æ™‚å€™) -->
            <div v-if="!currentResult && !isLoading" class="absolute inset-0 flex flex-col items-center justify-center text-gray-300 p-10 text-center">
                <span class="text-6xl mb-4 grayscale opacity-20">ğŸ½ï¸</span>
                <p class="text-lg font-serif text-gray-400">æº–å‚™å¥½ä½ çš„åˆé¤äº†å—ï¼Ÿ<br>é»æ“Šå·¦å´æŒ‰éˆ•é–‹å§‹ã€‚</p>
            </div>

            <!-- è¼‰å…¥ä¸­ç•«é¢ -->
            <div v-if="isLoading" class="absolute inset-0 flex items-center justify-center bg-white/80 backdrop-blur-sm z-30">
                <div class="loader w-12 h-12 border-4 border-gray-200 border-t-gray-800"></div>
            </div>

            <!-- çµæœå¡ç‰‡ -->
            <div v-if="currentResult" id="result-section" class="h-full flex flex-col animate-fade-in overflow-y-auto">
                
                <!-- åœ–ç‰‡å€ -->
                <div class="h-64 md:h-80 bg-gray-100 relative group shrink-0">
                    <img 
                        v-if="currentResult.photos && currentResult.photos.length > 0"
                        :src="currentResult.photos[0].getUrl({maxWidth: 800})" 
                        class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105"
                        alt="é¤å»³ç…§ç‰‡"
                    >
                    <div v-else class="w-full h-full flex flex-col items-center justify-center text-gray-400 gap-2">
                        <span class="text-4xl opacity-30">ğŸ“·</span>
                        <span class="text-sm">åº—å®¶æœªæä¾›ç…§ç‰‡</span>
                    </div>
                    
                    <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-6 pt-20">
                        <h2 class="text-3xl md:text-4xl font-bold text-white mb-2 leading-tight serif-font text-shadow-enhanced">{{ currentResult.name }}</h2>
                        
                        <!-- è©•åˆ†æ¨™ç±¤ï¼šå‹•æ…‹èƒŒæ™¯è‰² -->
                        <div class="flex items-center gap-3 text-white text-sm font-medium">
                            <span :class="getRatingColor(currentResult.rating)" class="text-white px-2 py-0.5 rounded text-xs font-bold shadow-sm flex items-center gap-1">
                                â­ {{ currentResult.rating || 'N/A' }}
                            </span>
                            <span v-if="currentResult.user_ratings_total" class="text-white/90 drop-shadow-md">
                                ({{ currentResult.user_ratings_total }} å‰‡è©•è«–)
                            </span>
                        </div>
                    </div>
                </div>

                <!-- è©³ç´°è³‡è¨Š -->
                <div class="p-6 md:p-10 space-y-8 bg-white flex-1">
                    
                    <!-- ç‡Ÿæ¥­è³‡è¨Š -->
                    <div class="flex items-center gap-3 text-sm border-b border-gray-100 pb-6">
                        <div :class="isOpenNow ? 'text-green-600 bg-green-50' : 'text-red-500 bg-red-50'" 
                             class="px-3 py-1 rounded-md font-bold flex items-center gap-2 border border-current/10">
                            <span v-if="isOpenNow" class="w-2 h-2 rounded-full bg-green-500"></span>
                            {{ displayTimeText }}
                        </div>
                    </div>

                    <!-- åœ°å€ -->
                    <div class="flex gap-4">
                        <span class="text-2xl">ğŸ“</span>
                        <div>
                            <p class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-1">LOCATION</p>
                            <p class="text-gray-800 text-lg leading-relaxed">{{ currentResult.vicinity || currentResult.formatted_address }}</p>
                        </div>
                    </div>

                    <!-- äº¤é€šè³‡è¨Š -->
                    <div class="flex gap-4">
                        <span class="text-2xl" v-if="finalTravelMode === 'TRANSIT'">ğŸšŒ</span>
                        <span class="text-2xl" v-else>ğŸš¶</span>
                        <div class="flex-1">
                            <p class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-1">
                                FROM {{ fullSearchQuery }}
                            </p>
                            
                            <div v-if="isCalculatingTime" class="text-gray-400 text-sm italic py-2">è¨ˆç®—è·¯ç¨‹ä¸­...</div>
                            
                            <div v-else-if="travelInfo">
                                <div class="flex items-baseline gap-3">
                                    <span class="text-3xl font-bold text-gray-800 font-sans">
                                        {{ travelInfo.duration.text }}
                                    </span>
                                    <span class="text-sm text-gray-500">{{ travelInfo.distance.text }}</span>
                                </div>
                                
                                <div class="mt-2 flex flex-wrap gap-2">
                                    <span v-if="finalTravelMode === 'TRANSIT' && transitLine" class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded border border-blue-200">
                                        {{ transitLine }}
                                    </span>
                                    <span v-if="comparisonNote" class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">
                                        {{ comparisonNote }}
                                    </span>
                                </div>
                            </div>
                            <div v-else class="text-sm text-gray-400 italic">è·é›¢éè¿‘æˆ–ç„¡æ³•è¨ˆç®—</div>
                        </div>
                    </div>

                    <!-- å°èˆªæŒ‰éˆ• -->
                    <div class="grid grid-cols-2 gap-4 pt-4 mt-auto">
                        <a :href="'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(currentResult.name) + '&query_place_id=' + currentResult.place_id" target="_blank" class="bg-white border-2 border-gray-800 text-gray-800 hover:bg-gray-50 active:scale-[0.98] py-3 rounded-lg text-center font-bold text-sm transition-all">
                            é–‹å•Ÿåœ°åœ–
                        </a>
                        <button @click="reset" class="bg-gray-100 text-gray-500 hover:bg-gray-200 active:scale-[0.98] py-3 rounded-lg font-bold text-sm transition-all">
                            æ¸…é™¤çµæœ
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    // ==========================================
    // â–¼ å·²ç¶“å¹«ä½ æŠŠé‡‘é‘°å¡«å¥½äº† â–¼
    // ==========================================
    const YOUR_API_KEY = 'AIzaSyC0LqN7gsdMS1fI8brrHDelMW7KzddInJM'; 
    // ==========================================

    const { createApp } = Vue;
    createApp({
        data() {
            return {
                isMapsReady: false,
                
                // å°ç£è¡Œæ”¿å€è³‡æ–™
                taiwanData: {
                    "åŸºéš†å¸‚": ["ä»æ„›å€", "ä¿¡ç¾©å€", "ä¸­æ­£å€", "ä¸­å±±å€", "å®‰æ¨‚å€", "æš–æš–å€", "ä¸ƒå µå€"],
                    "è‡ºåŒ—å¸‚": ["ä¸­æ­£å€", "å¤§åŒå€", "ä¸­å±±å€", "æ¾å±±å€", "å¤§å®‰å€", "è¬è¯å€", "ä¿¡ç¾©å€", "å£«æ—å€", "åŒ—æŠ•å€", "å…§æ¹–å€", "å—æ¸¯å€", "æ–‡å±±å€"],
                    "æ–°åŒ—å¸‚": ["æ¿æ©‹å€", "ä¸‰é‡å€", "ä¸­å’Œå€", "æ°¸å’Œå€", "æ–°èŠå€", "æ–°åº—å€", "æ¨¹æ—å€", "é¶¯æ­Œå€", "ä¸‰å³½å€", "æ·¡æ°´å€", "æ±æ­¢å€", "ç‘èŠ³å€", "åœŸåŸå€", "è˜†æ´²å€", "äº”è‚¡å€", "æ³°å±±å€", "æ—å£å€", "æ·±å‘å€", "çŸ³ç¢‡å€", "åªæ—å€", "ä¸‰èŠå€", "çŸ³é–€å€", "å…«é‡Œå€", "å¹³æºªå€", "é›™æºªå€", "è²¢å¯®å€", "é‡‘å±±å€", "è¬é‡Œå€", "çƒä¾†å€"],
                    "æ¡ƒåœ’å¸‚": ["æ¡ƒåœ’å€", "ä¸­å£¢å€", "å¤§æºªå€", "æ¥Šæ¢…å€", "è˜†ç«¹å€", "å¤§åœ’å€", "é¾œå±±å€", "å…«å¾·å€", "é¾æ½­å€", "å¹³é®å€", "æ–°å±‹å€", "è§€éŸ³å€", "å¾©èˆˆå€"],
                    "æ–°ç«¹å¸‚": ["æ±å€", "åŒ—å€", "é¦™å±±å€"],
                    "æ–°ç«¹ç¸£": ["ç«¹åŒ—å¸‚", "ç«¹æ±é®", "æ–°åŸ”é®", "é—œè¥¿é®", "æ¹–å£é„‰", "æ–°è±é„‰", "èŠæ—é„‰", "æ©«å±±é„‰", "åŒ—åŸ”é„‰", "å¯¶å±±é„‰", "å³¨çœ‰é„‰", "å°–çŸ³é„‰", "äº”å³°é„‰"],
                    "è‹—æ —ç¸£": ["è‹—æ —å¸‚", "é ­ä»½å¸‚", "è‹‘è£¡é®", "é€šéœ„é®", "ç«¹å—é®", "å¾Œé¾é®", "å“è˜­é®", "å¤§æ¹–é„‰", "å…¬é¤¨é„‰", "éŠ…é‘¼é„‰", "å—åº„é„‰", "é ­å±‹é„‰", "ä¸‰ç¾©é„‰", "è¥¿æ¹–é„‰", "é€ æ©‹é„‰", "ä¸‰ç£é„‰", "ç…æ½­é„‰", "æ³°å®‰é„‰"],
                    "è‡ºä¸­å¸‚": ["ä¸­å€", "æ±å€", "å—å€", "è¥¿å€", "åŒ—å€", "è¥¿å±¯å€", "å—å±¯å€", "åŒ—å±¯å€", "è±åŸå€", "æ±å‹¢å€", "å¤§ç”²å€", "æ¸…æ°´å€", "æ²™é¹¿å€", "æ¢§æ£²å€", "åé‡Œå€", "ç¥å²¡å€", "æ½­å­å€", "å¤§é›…å€", "æ–°ç¤¾å€", "çŸ³å²¡å€", "å¤–åŸ”å€", "å¤§å®‰å€", "çƒæ—¥å€", "å¤§è‚šå€", "é¾äº•å€", "éœ§å³°å€", "å¤ªå¹³å€", "å¤§é‡Œå€", "å’Œå¹³å€"],
                    "å½°åŒ–ç¸£": ["å½°åŒ–å¸‚", "å“¡æ—å¸‚", "é¹¿æ¸¯é®", "å’Œç¾é®", "åŒ—æ–—é®", "æºªæ¹–é®", "ç”°ä¸­é®", "äºŒæ—é®", "ç·šè¥¿é„‰", "ä¼¸æ¸¯é„‰", "ç¦èˆˆé„‰", "ç§€æ°´é„‰", "èŠ±å£‡é„‰", "èŠ¬åœ’é„‰", "å¤§æ‘é„‰", "åŸ”é¹½é„‰", "åŸ”å¿ƒé„‰", "æ°¸é–é„‰", "ç¤¾é ­é„‰", "äºŒæ°´é„‰", "ç”°å°¾é„‰", "åŸ¤é ­é„‰", "èŠ³è‹‘é„‰", "å¤§åŸé„‰", "ç«¹å¡˜é„‰", "æºªå·é„‰"],
                    "å—æŠ•ç¸£": ["å—æŠ•å¸‚", "åŸ”é‡Œé®", "è‰å±¯é®", "ç«¹å±±é®", "é›†é›†é®", "åé–“é„‰", "é¹¿è°·é„‰", "ä¸­å¯®é„‰", "é­šæ± é„‰", "åœ‹å§“é„‰", "æ°´é‡Œé„‰", "ä¿¡ç¾©é„‰", "ä»æ„›é„‰"],
                    "é›²æ—ç¸£": ["æ–—å…­å¸‚", "æ–—å—é®", "è™å°¾é®", "è¥¿èºé®", "åœŸåº«é®", "åŒ—æ¸¯é®", "å¤å‘é„‰", "å¤§åŸ¤é„‰", "è¿æ¡é„‰", "æ—å…§é„‰", "äºŒå´™é„‰", "å´™èƒŒé„‰", "éº¥å¯®é„‰", "æ±å‹¢é„‰", "è¤’å¿ é„‰", "è‡ºè¥¿é„‰", "å…ƒé•·é„‰", "å››æ¹–é„‰", "å£æ¹–é„‰", "æ°´æ—é„‰"],
                    "å˜‰ç¾©å¸‚": ["æ±å€", "è¥¿å€"],
                    "å˜‰ç¾©ç¸£": ["å¤ªä¿å¸‚", "æœ´å­å¸‚", "å¸ƒè¢‹é®", "å¤§æ—é®", "æ°‘é›„é„‰", "æºªå£é„‰", "æ–°æ¸¯é„‰", "å…­è…³é„‰", "æ±çŸ³é„‰", "ç¾©ç«¹é„‰", "é¹¿è‰é„‰", "æ°´ä¸Šé„‰", "ä¸­åŸ”é„‰", "ç«¹å´é„‰", "æ¢…å±±é„‰", "ç•ªè·¯é„‰", "å¤§åŸ”é„‰", "é˜¿é‡Œå±±é„‰"],
                    "è‡ºå—å¸‚": ["æ–°ç‡Ÿå€", "é¹½æ°´å€", "ç™½æ²³å€", "æŸ³ç‡Ÿå€", "å¾Œå£å€", "æ±å±±å€", "éº»è±†å€", "ä¸‹ç‡Ÿå€", "å…­ç”²å€", "å®˜ç”°å€", "å¤§å…§å€", "ä½³é‡Œå€", "å­¸ç”²å€", "è¥¿æ¸¯å€", "ä¸ƒè‚¡å€", "å°‡è»å€", "åŒ—é–€å€", "æ–°åŒ–å€", "å–„åŒ–å€", "æ–°å¸‚å€", "å®‰å®šå€", "å±±ä¸Šå€", "ç‰äº•å€", "æ¥ è¥¿å€", "å—åŒ–å€", "å·¦é®å€", "ä»å¾·å€", "æ­¸ä»å€", "é—œå»Ÿå€", "é¾å´å€", "æ°¸åº·å€", "æ±å€", "å—å€", "åŒ—å€", "å®‰å—å€", "å®‰å¹³å€", "ä¸­è¥¿å€"],
                    "é«˜é›„å¸‚": ["é¹½åŸ•å€", "é¼“å±±å€", "å·¦ç‡Ÿå€", "æ¥ æ¢“å€", "ä¸‰æ°‘å€", "æ–°èˆˆå€", "å‰é‡‘å€", "è‹“é›…å€", "å‰é®å€", "æ——æ´¥å€", "å°æ¸¯å€", "é³³å±±å€", "æ—åœ’å€", "å¤§å¯®å€", "å¤§æ¨¹å€", "å¤§ç¤¾å€", "ä»æ­¦å€", "é³¥æ¾å€", "å²¡å±±å€", "æ©‹é ­å€", "ç‡•å·¢å€", "ç”°å¯®å€", "é˜¿è“®å€", "è·¯ç«¹å€", "æ¹–å…§å€", "èŒ„è£å€", "æ°¸å®‰å€", "å½Œé™€å€", "æ¢“å®˜å€", "æ——å±±å€", "ç¾æ¿ƒå€", "å…­é¾œå€", "ç”²ä»™å€", "æ‰æ—å€", "å…§é–€å€", "èŒ‚æ—å€", "æ¡ƒæºå€", "é‚£ç‘ªå¤å€"],
                    "å±æ±ç¸£": ["å±æ±å¸‚", "æ½®å·é®", "æ±æ¸¯é®", "æ†æ˜¥é®", "è¬ä¸¹é„‰", "é•·æ²»é„‰", "éºŸæ´›é„‰", "ä¹å¦‚é„‰", "é‡Œæ¸¯é„‰", "é¹½åŸ”é„‰", "é«˜æ¨¹é„‰", "è¬å·’é„‰", "å…§åŸ”é„‰", "ç«¹ç”°é„‰", "æ–°åŸ¤é„‰", "æ‹å¯®é„‰", "æ–°åœ’é„‰", "å´é ‚é„‰", "æ—é‚Šé„‰", "å—å·é„‰", "ä½³å†¬é„‰", "ç‰çƒé„‰", "è»ŠåŸé„‰", "æ»¿å·é„‰", "æ‹å±±é„‰", "ä¸‰åœ°é–€é„‰", "éœ§è‡ºé„‰", "ç‘ªå®¶é„‰", "æ³°æ­¦é„‰", "ä¾†ç¾©é„‰", "æ˜¥æ—¥é„‰", "ç…å­é„‰", "ç‰¡ä¸¹é„‰"],
                    "å®œè˜­ç¸£": ["å®œè˜­å¸‚", "ç¾…æ±é®", "è˜‡æ¾³é®", "é ­åŸé®", "ç¤æºªé„‰", "å£¯åœé„‰", "å“¡å±±é„‰", "å†¬å±±é„‰", "äº”çµé„‰", "ä¸‰æ˜Ÿé„‰", "å¤§åŒé„‰", "å—æ¾³é„‰"],
                    "èŠ±è“®ç¸£": ["èŠ±è“®å¸‚", "é³³æ—é®", "ç‰é‡Œé®", "æ–°åŸé„‰", "å‰å®‰é„‰", "å£½è±é„‰", "å…‰å¾©é„‰", "è±æ¿±é„‰", "ç‘ç©—é„‰", "å¯Œé‡Œé„‰", "ç§€æ—é„‰", "è¬æ¦®é„‰", "å“æºªé„‰"],
                    "è‡ºæ±ç¸£": ["è‡ºæ±å¸‚", "æˆåŠŸé®", "é—œå±±é®", "å‘å—é„‰", "å¤§æ­¦é„‰", "å¤ªéº»é‡Œé„‰", "æ±æ²³é„‰", "é•·æ¿±é„‰", "é¹¿é‡é„‰", "æ± ä¸Šé„‰", "ç¶ å³¶é„‰", "è˜­å¶¼é„‰", "å»¶å¹³é„‰", "é‡‘å³°é„‰", "é”ä»é„‰", "æµ·ç«¯é„‰"],
                    "æ¾æ¹–ç¸£": ["é¦¬å…¬å¸‚", "æ¹–è¥¿é„‰", "ç™½æ²™é„‰", "è¥¿å¶¼é„‰", "æœ›å®‰é„‰", "ä¸ƒç¾é„‰"],
                    "é‡‘é–€ç¸£": ["é‡‘åŸé®", "é‡‘æ¹–é®", "é‡‘æ²™é®", "é‡‘å¯§é„‰", "çƒˆå¶¼é„‰", "çƒåµé„‰"],
                    "é€£æ±Ÿç¸£": ["å—ç«¿é„‰", "åŒ—ç«¿é„‰", "è’å…‰é„‰", "æ±å¼•é„‰"]
                },
                
                selectedCity: 'æ–°åŒ—å¸‚', // é è¨­å€¼
                selectedDistrict: 'æ¿æ©‹å€',
                specificLocation: '',
                
                newExcludeTag: '',
                excludeTags: ['é€Ÿé£Ÿ', 'æ˜Ÿå·´å…‹', 'ç”œé»', 'éº¥ç•¶å‹', '7-ELEVEN'],
                onlyOpen: true,
                
                currentResult: null,
                isLoading: false,
                loadingStatus: '', 
                isCalculatingTime: false,
                errorMessage: '',
                debugInfo: '', 
                
                travelInfo: null, 
                finalTravelMode: 'WALKING', 
                transitLine: '', 
                comparisonNote: '', 
                
                displayTimeText: '', 
                isOpenNow: false,
                totalCandidates: 0,
                safetyTimer: null 
            }
        },
        computed: {
            availableDistricts() {
                if (!this.selectedCity) return [];
                return this.taiwanData[this.selectedCity] || [];
            },
            fullSearchQuery() {
                // çµ„åˆå®Œæ•´æœå°‹å­—ä¸²ï¼š[ç¸£å¸‚][åœ°å€][è©³ç´°åœ°æ¨™]
                let query = '';
                if (this.selectedCity) query += this.selectedCity;
                if (this.selectedDistrict) query += this.selectedDistrict;
                if (this.specificLocation) query += ' ' + this.specificLocation;
                return query;
            }
        },
        mounted() {
            this.loadGoogleMaps();
        },
        methods: {
            handleCityChange() {
                this.selectedDistrict = ''; // æ›ç¸£å¸‚æ™‚æ¸…ç©ºåœ°å€
                this.specificLocation = '';
            },
            // æ–°å¢è©•åˆ†é¡è‰²åˆ¤æ–·é‚è¼¯
            getRatingColor(rating) {
                if (!rating) return 'bg-gray-400';
                const r = parseFloat(rating);
                if (r >= 4.5) return 'bg-green-600'; // ç¶ è‰²
                if (r >= 4.0) return 'bg-orange-500'; // æ©˜è‰²
                if (r >= 3.5) return 'bg-orange-700'; // æ©˜ç´…è‰² (Tailwind orange-700 åç´…æ£•)
                return 'bg-red-600'; // ç´…è‰²
            },

            loadGoogleMaps() {
                if (!YOUR_API_KEY || YOUR_API_KEY.includes('è«‹å°‡é€™ä¸²æ–‡å­—')) {
                    this.errorMessage = "è«‹å¡«å…¥ API é‡‘é‘°ã€‚";
                    return;
                }
                
                window.initMapCallback = () => {
                    try {
                        const dummyDiv = document.createElement('div');
                        const map = new google.maps.Map(dummyDiv);
                        this.service = new google.maps.places.PlacesService(map);
                        this.geocoder = new google.maps.Geocoder();
                        this.directionsService = new google.maps.DirectionsService(); 
                        this.isMapsReady = true;
                    } catch (e) {
                        this.errorMessage = "åœ°åœ–åˆå§‹åŒ–éŒ¯èª¤: " + e.message;
                    }
                };

                window.gm_authFailure = () => {
                    this.errorMessage = "Google Maps API èº«åˆ†é©—è­‰å¤±æ•—ï¼å¯èƒ½æ˜¯ã€Œç¶²ç«™é™åˆ¶ã€æ“‹ä½äº†ã€‚";
                };

                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${YOUR_API_KEY}&libraries=places&language=zh-TW&callback=initMapCallback`;
                script.async = true;
                script.onerror = () => { 
                    this.errorMessage = "ç„¡æ³•è¼‰å…¥ Google Mapsï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–é‡‘é‘°æ¬Šé™ã€‚"; 
                };
                document.head.appendChild(script);
            },
            addTag() {
                if (this.newExcludeTag.trim()) {
                    this.excludeTags.push(this.newExcludeTag.trim());
                    this.newExcludeTag = '';
                }
            },
            removeTag(idx) { this.excludeTags.splice(idx, 1); },
            
            findLunch() {
                if (!this.isMapsReady) return;
                
                // æª¢æŸ¥æ˜¯å¦é¸æ“‡äº†åœ°é»
                if (!this.selectedCity || !this.selectedDistrict) {
                    this.errorMessage = "è«‹å…ˆé¸æ“‡ç¸£å¸‚å’Œåœ°å€";
                    return;
                }

                this.isLoading = true;
                this.errorMessage = '';
                this.debugInfo = '';
                this.currentResult = null;
                this.travelInfo = null;
                this.totalCandidates = 0;

                if (this.safetyTimer) clearTimeout(this.safetyTimer);
                this.safetyTimer = setTimeout(() => {
                    if (this.isLoading) {
                        this.isLoading = false;
                        this.errorMessage = "æœå°‹æ™‚é–“éé•·ï¼Œå¯èƒ½æ˜¯é™„è¿‘åº—å®¶å¤ªå¤šæˆ–ç¶²è·¯å•é¡Œï¼Œè«‹é‡è©¦ã€‚";
                    }
                }, 45000); 

                // ä½¿ç”¨çµ„åˆå¥½çš„ fullSearchQuery é€²è¡Œæœå°‹
                this.geocoder.geocode({ 
                    address: this.fullSearchQuery,
                    componentRestrictions: { country: 'TW' } 
                }, (results, status) => {
                    if (status === 'OK') {
                        const loc = results[0].geometry.location;
                        this.radarScan(loc); 
                    } else {
                        this.isLoading = false;
                        this.errorMessage = "æ‰¾ä¸åˆ°é€™å€‹åœ°é»ï¼Œè«‹ç¢ºèªåœ°å€æ˜¯å¦æ­£ç¢ºã€‚";
                        this.debugInfo = status;
                    }
                });
            },
            
            async radarScan(centerLoc) {
                const radius = 700; 
                const points = [centerLoc];
                for(let i=0; i<3; i++) {
                    points.push(this.getRandomOffset(centerLoc, 300));
                }

                try {
                    const allScanPromises = points.map(point => this.singlePointSearch(point, radius));
                    const outcomes = await Promise.all(allScanPromises);
                    
                    let combined = [];
                    const seenIds = new Set();
                    
                    outcomes.forEach(results => {
                        results.forEach(place => {
                            if (place && place.place_id && !seenIds.has(place.place_id)) {
                                seenIds.add(place.place_id);
                                combined.push(place);
                            }
                        });
                    });

                    if (combined.length === 0) {
                        this.errorMessage = "é™„è¿‘å®Œå…¨æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„ç¾é£Ÿã€‚";
                        this.isLoading = false;
                        return;
                    }

                    this.processAllCandidates(combined, centerLoc);
                } catch (e) {
                    this.errorMessage = "æœå°‹ç™¼ç”Ÿæœªé æœŸçš„éŒ¯èª¤ã€‚";
                    this.debugInfo = e.message;
                    this.isLoading = false;
                }
            },

            getRandomOffset(location, meters) {
                const r = meters / 111300; 
                const y0 = location.lat();
                const x0 = location.lng();
                const u = Math.random();
                const v = Math.random();
                const w = r * Math.sqrt(u);
                const t = 2 * Math.PI * v;
                const x = w * Math.cos(t);
                const y = w * Math.sin(t);
                const xAdjusted = x / Math.cos(y0);
                return new google.maps.LatLng(y + y0, xAdjusted + x0);
            },

            singlePointSearch(location, radius) {
                return new Promise((resolve) => {
                    const req = { location, radius, keyword: 'ç¾é£Ÿ' };
                    let allResults = [];
                    
                    const callback = (results, status, pagination) => {
                        if (status === google.maps.places.PlacesServiceStatus.OK) {
                            allResults = allResults.concat(results);
                            if (pagination && pagination.hasNextPage && allResults.length < 60) {
                                setTimeout(() => {
                                    pagination.nextPage();
                                }, 2000); 
                            } else {
                                resolve(allResults);
                            }
                        } else {
                            resolve(allResults);
                        }
                    };

                    this.service.nearbySearch(req, callback);
                });
            },

            processAllCandidates(results, userLoc) {
                for (let i = results.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [results[i], results[j]] = [results[j], results[i]];
                }

                let candidates = results.filter(p => !this.excludeTags.some(tag => p.name.includes(tag)));
                this.totalCandidates = candidates.length;
                
                if (candidates.length === 0) {
                    this.errorMessage = "æ‰€æœ‰åº—å®¶éƒ½è¢«æ’é™¤æ¢ä»¶éæ¿¾æ‰äº†ã€‚";
                    this.isLoading = false;
                    return;
                }

                this.tryFindValidPlace(candidates, userLoc);
            },

            tryFindValidPlace(candidates, userLoc) {
                if (candidates.length === 0) {
                    this.errorMessage = "é›–ç„¶æ‰¾åˆ°å¾ˆå¤šåº—ï¼Œä½†åˆ†æå¾Œç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡è©¦ã€‚";
                    this.isLoading = false;
                    return;
                }
                
                const candidate = candidates.shift();
                
                setTimeout(() => {
                    const request = {
                        placeId: candidate.place_id,
                        fields: ['name', 'rating', 'formatted_address', 'vicinity', 'photos', 'opening_hours', 'geometry', 'user_ratings_total', 'place_id']
                    };

                    this.service.getDetails(request, (place, status) => {
                        if (status === 'OK') {
                            this.currentResult = place;
                            this.processOpeningHours(place);
                            this.compareTravelOptions(userLoc, place.geometry.location);
                            this.isLoading = false;
                            if (this.safetyTimer) clearTimeout(this.safetyTimer);
                        } else {
                            this.tryFindValidPlace(candidates, userLoc);
                        }
                    });
                }, 150);
            },

            processOpeningHours(place) {
                this.displayTimeText = 'æ™‚é–“æœªçŸ¥';
                this.isOpenNow = false;
                const jsDay = new Date().getDay();
                const daysMap = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'];
                if (place.opening_hours) {
                    this.isOpenNow = place.opening_hours.isOpen();
                    if (place.opening_hours.weekday_text) {
                        const googleIndex = (jsDay === 0) ? 6 : jsDay - 1;
                        let raw = place.opening_hours.weekday_text[googleIndex];
                        if (raw) {
                            const colon = raw.indexOf(':');
                            this.displayTimeText = daysMap[jsDay] + ' ' + (colon > -1 ? raw.substring(colon + 1).trim() : raw);
                        }
                    }
                }
                if (this.displayTimeText.includes('æ™‚é–“æœªçŸ¥')) this.displayTimeText = daysMap[jsDay] + (this.isOpenNow ? ' ç‡Ÿæ¥­ä¸­' : ' ä¼‘æ¯ä¸­');
            },

            compareTravelOptions(origin, dest) {
                this.isCalculatingTime = true;
                const getRoute = (mode) => {
                    return new Promise((resolve) => {
                        this.directionsService.route({ origin, destination: dest, travelMode: mode }, (res, status) => {
                            if (status === 'OK') resolve(res.routes[0].legs[0]);
                            else resolve(null);
                        });
                    });
                };

                Promise.all([getRoute('WALKING'), getRoute('TRANSIT')]).then(([walkRes, transitRes]) => {
                    this.isCalculatingTime = false;
                    if (!walkRes) return;
                    const walkMin = Math.ceil(walkRes.duration.value / 60);
                    if (walkMin <= 20 || !transitRes) {
                        this.travelInfo = walkRes;
                        this.finalTravelMode = 'WALKING';
                        this.comparisonNote = "èµ°è·¯æœ€æ–¹ä¾¿";
                    } else {
                        this.travelInfo = transitRes;
                        this.finalTravelMode = 'TRANSIT';
                        const transitStep = transitRes.steps.find(s => s.travel_mode === 'TRANSIT');
                        this.transitLine = transitStep?.transit?.line?.short_name || 'å¤§çœ¾é‹è¼¸';
                        this.comparisonNote = `æ¯”èµ°è·¯å¿« ${walkMin - Math.ceil(transitRes.duration.value/60)} åˆ†é˜`;
                    }
                });
            },

            reset() { this.currentResult = null; this.errorMessage = ''; }
        }
    }).mount('#app');
</script>
</body>
</html>
